/*
 * EspLedcFader.cpp
 *
 *  Created on: 05.11.2019
 *      Author: gesser
 */

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

#include "EspLedcFader.h"
#include "EspLedcTimer.h"

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

namespace UxEspCppLibrary
{

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EspLedcFader::EspLedcFader()
                                    : EspLedcChannel( "EspLedcFader" )
                                      {
                                      }

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EspLedcFader::EspLedcFader( const std::string & strLogName )
: EspLedcChannel( strLogName )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EspLedcFader::~EspLedcFader()
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

esp_err_t EspLedcFader::init( const ledc_channel_t nLedcChannel,
                              const gpio_num_t     nGpioNum,
                              EspLedcTimer *       pLedcTimer,
                              const uint32_t       u32FadeInDuty,
                              const uint32_t       u32FadeInTimeMs,
                              const uint32_t       u32FadeOutDuty,
                              const uint32_t       u32FadeOutTimeMs )
{
    m_u32FadeInDuty    = u32FadeInDuty;
    m_u32FadeInTimeMs  = u32FadeInTimeMs;
    m_u32FadeOutDuty   = u32FadeOutDuty;
    m_u32FadeOutTimeMs = u32FadeOutTimeMs;

    esp_err_t nEspError = EspLedcChannel::init( nLedcChannel, nGpioNum, pLedcTimer );

    setDuty( u32FadeOutDuty );

    return nEspError;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t EspLedcFader::fadeInTimeMs( void ) const
{
    return m_u32FadeInTimeMs;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t EspLedcFader::fadeOutTimeMs( void ) const
{
    return m_u32FadeOutTimeMs;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

esp_err_t EspLedcFader::fadeIn( void )
{
    esp_err_t nEspError = ESP_FAIL;

    if ( ledcTimer() )
    {
        nEspError = ledc_set_fade_time_and_start( ledcTimer()->speedMode(),
                                                  channel(),
                                                  m_u32FadeInDuty,
                                                  m_u32FadeInTimeMs,
                                                  LEDC_FADE_NO_WAIT );
    }

    return nEspError;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

esp_err_t EspLedcFader::fadeOut( void )
{
    esp_err_t nEspError = ESP_FAIL;

    if ( ledcTimer() )
    {
        nEspError =  ledc_set_fade_time_and_start( ledcTimer()->speedMode(),
                                                   channel(),
                                                   m_u32FadeOutDuty,
                                                   m_u32FadeOutTimeMs,
                                                   LEDC_FADE_NO_WAIT );
    }

    return nEspError;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t EspLedcFader::fadeInDuty( void ) const
{
    return m_u32FadeInDuty;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t EspLedcFader::fadeOutDuty( void ) const
{
    return m_u32FadeOutDuty;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void EspLedcFader::setFadeSettings( const uint32_t u32FadeInDuty,
                                    const uint32_t u32FadeInTimeMs,
                                    const uint32_t u32FadeOutDuty,
                                    const uint32_t u32FadeOutTimeMs )
{
    m_u32FadeInDuty    = u32FadeInDuty;
    m_u32FadeInTimeMs  = u32FadeInTimeMs;
    m_u32FadeOutDuty   = u32FadeOutDuty;
    m_u32FadeOutTimeMs = u32FadeOutTimeMs;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

// static
esp_err_t EspLedcFader::install( const int nIntrAllocFlags )
{
    return ledc_fade_func_install( nIntrAllocFlags );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

} // namespace UxEspCppLibrary

