/*
 * EkxProtocol.cpp
 *
 *  Created on: 30.04.2023
 *      Author: gesser
 */

#include "EkxProtocol.h"
#include <cstring>
#include <cassert>

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

namespace EkxProtocol
{

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

namespace ProtoApi
{

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Message::Message()
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Message::~Message()
{
    m_dataList.clear();
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void Message::registerData( DataBase * const pData )
{
    m_dataList.push_back( pData );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const std::string & Message::serializedData() const
{
    return m_strSerializedData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void Message::serialize() const
{
    m_strSerializedData.clear();

    for ( DataBase * pData : m_dataList )
    {
        pData->serializeData();
    }
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

bool Message::deserialize( const std::string & data ) const
{
    m_strSerializedData = data;
    m_u32DeserializePos = 0;

    bool bSuccess = true;

    for ( DataBase * pData : m_dataList )
    {
        bSuccess = bSuccess
                   && pData->deserializeData();
    }

    if ( bSuccess
         && m_u32DeserializePos != data.size() )
    {
        bSuccess = false;
        printf( "Message::deserialize() parsed data not matching to message end\n" );
    }

    return bSuccess;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

bool Message::deserialize( Message & message ) const
{
    bool bSuccess = true;

    for ( DataBase * pData : m_dataList )
    {
        bSuccess = bSuccess
                   && pData->deserializeData( message );
    }

    return bSuccess;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void Message::serializeData( const void * const pData,
                             const uint32_t     u32Size ) const
{
    uint32_t u32CurrentSize = m_strSerializedData.size();

    m_strSerializedData.resize( u32CurrentSize + u32Size );

    std::memcpy( const_cast<char *>( m_strSerializedData.data() ) + u32CurrentSize, pData, u32Size );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

bool Message::deserializeData( void * const   pData,
                               const uint32_t u32Size ) const
{
    bool bSuccess = false;

    if ( m_strSerializedData.size() >= m_u32DeserializePos + u32Size )
    {
        std::memcpy( pData, m_strSerializedData.data() + m_u32DeserializePos, u32Size );
        m_u32DeserializePos += u32Size;

        bSuccess = true;
    }

    return bSuccess;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t Message::size() const
{
    uint32_t u32Size = 0;

    for ( DataBase * pData : m_dataList )
    {
        u32Size += pData->size();
    }

    return u32Size;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

DataBase::DataBase( Message * const pMessage )
    : m_pMessage( pMessage )
{
    if ( m_pMessage )
    {
        m_pMessage->registerData( this );
    }
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

DataBase::~DataBase()
{
    m_pMessage = nullptr;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

bool DataBase::deserializeData()
{
    return deserializeData( *message() );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const Message * DataBase::message() const
{
    return m_pMessage;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Message * DataBase::message()
{
    return m_pMessage;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

DataString::DataString( Message * const pMessage )
    : DataBase( pMessage )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void DataString::serializeData() const
{
    uint16_t u16Size = m_strValue.size();

    message()->serializeData( &u16Size, sizeof( u16Size ) );
    message()->serializeData( m_strValue.data(), m_strValue.size() );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

bool DataString::deserializeData( Message & message )
{
    bool bSuccess = true;

    uint16_t u16Size = 0;
    bSuccess = bSuccess
               && message.deserializeData( &u16Size, sizeof( u16Size ) );
    m_strValue.resize( u16Size, 0 );
    bSuccess = bSuccess
               && message.deserializeData( const_cast<char *>( m_strValue.data() ), u16Size );

    return bSuccess;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t DataString::size() const
{
    return sizeof( uint16_t ) + m_strValue.size();
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const std::string & DataString::value() const
{
    return m_strValue;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void DataString::setValue( const std::string & strValue )
{
    m_strValue = strValue;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

} // namespace ProtoApi

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

namespace Payload
{

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload::MessagePayload( const PayloadType payloadType )
    : m_payloadType( payloadType )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

PayloadType MessagePayload::payloadType() const
{
    return m_payloadType;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

DcHallStartMotor::DcHallStartMotor()
    : MessagePayload( PayloadType::DcHallStartMotor )
    , m_pwmDuty10th( this )
    , m_pwmFrequency( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & DcHallStartMotor::pwmDuty10th()
{
    return m_pwmDuty10th;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * DcHallStartMotor::clone() const
{
    return new DcHallStartMotor( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & DcHallStartMotor::pwmDuty10th() const
{
    return m_pwmDuty10th;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & DcHallStartMotor::pwmFrequency()
{
    return m_pwmFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & DcHallStartMotor::pwmFrequency() const
{
    return m_pwmFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

DcHallStartMotorSteps::DcHallStartMotorSteps()
    : MessagePayload( PayloadType::DcHallStartMotorSteps )
    , m_pwmDuty10th( this )
    , m_pwmFrequency( this )
    , m_steps( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & DcHallStartMotorSteps::pwmDuty10th()
{
    return m_pwmDuty10th;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & DcHallStartMotorSteps::pwmFrequency()
{
    return m_pwmFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * DcHallStartMotorSteps::clone() const
{
    return new DcHallStartMotorSteps( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & DcHallStartMotorSteps::pwmDuty10th() const
{
    return m_pwmDuty10th;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & DcHallStartMotorSteps::pwmFrequency() const
{
    return m_pwmFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & DcHallStartMotorSteps::steps()
{
    return m_steps;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & DcHallStartMotorSteps::steps() const
{
    return m_steps;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

DcHallStatus::DcHallStatus()
    : MessagePayload( PayloadType::DcHallStatus )
    , m_valid( this )
    , m_faultPinActive( this )
    , m_motorRunning( this )
    , m_motorRunTime( this )
    , m_motorTestOk( this )
    , m_stepCounter( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & DcHallStatus::valid()
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & DcHallStatus::valid() const
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & DcHallStatus::faultPinActive()
{
    return m_faultPinActive;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & DcHallStatus::faultPinActive() const
{
    return m_faultPinActive;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & DcHallStatus::motorRunning()
{
    return m_motorRunning;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & DcHallStatus::motorRunning() const
{
    return m_motorRunning;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint64_t> & DcHallStatus::motorRunTime()
{
    return m_motorRunTime;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint64_t> & DcHallStatus::motorRunTime() const
{
    return m_motorRunTime;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & DcHallStatus::motorTestOk()
{
    return m_motorTestOk;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & DcHallStatus::motorTestOk() const
{
    return m_motorTestOk;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * DcHallStatus::clone() const
{
    return new DcHallStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & DcHallStatus::stepCounter()
{
    return m_stepCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & DcHallStatus::stepCounter() const
{
    return m_stepCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EepromStatus::EepromStatus()
    : MessagePayload( PayloadType::EepromStatus )
    , m_valid( this )
    , m_productNo( this )
    , m_serialNo( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & EepromStatus::valid()
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & EepromStatus::valid() const
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & EepromStatus::productNo()
{
    return m_productNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & EepromStatus::productNo() const
{
    return m_productNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * EepromStatus::clone() const
{
    return new EepromStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & EepromStatus::serialNo()
{
    return m_serialNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & EepromStatus::serialNo() const
{
    return m_serialNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EepromFlash::EepromFlash()
    : MessagePayload( PayloadType::EepromFlash )
    , m_productNo( this )
    , m_serialNo( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & EepromFlash::productNo()
{
    return m_productNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * EepromFlash::clone() const
{
    return new EepromFlash( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & EepromFlash::productNo() const
{
    return m_productNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & EepromFlash::serialNo() const
{
    return m_serialNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & EepromFlash::serialNo()
{
    return m_serialNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

PwmSetDuty::PwmSetDuty()
    : MessagePayload( PayloadType::PwmSetDuty )
    , m_pwmDuty( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * PwmSetDuty::clone() const
{
    return new PwmSetDuty( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & PwmSetDuty::pwmDuty()
{
    return m_pwmDuty;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & PwmSetDuty::pwmDuty() const
{
    return m_pwmDuty;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

PwmFaderSettings::PwmFaderSettings()
    : MessagePayload( PayloadType::PwmFaderSettings )
    , m_fadeInDutyPercent( this )
    , m_fadeOutDutyPercent( this )
    , m_fadeInTimeMs( this )
    , m_fadeOutTimeMs( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeInDutyPercent()
{
    return m_fadeInDutyPercent;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeOutDutyPercent()
{
    return m_fadeOutDutyPercent;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeInTimeMs()
{
    return m_fadeInTimeMs;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * PwmFaderSettings::clone() const
{
    return new PwmFaderSettings( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeInDutyPercent() const
{
    return m_fadeInDutyPercent;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeOutDutyPercent() const
{
    return m_fadeOutDutyPercent;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeInTimeMs() const
{
    return m_fadeInTimeMs;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeOutTimeMs()
{
    return m_fadeOutTimeMs;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & PwmFaderSettings::fadeOutTimeMs() const
{
    return m_fadeOutTimeMs;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

DiscreteStatus::DiscreteStatus()
    : MessagePayload( PayloadType::DiscreteStatus )
    , m_valid( this )
    , m_discreteHigh( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & DiscreteStatus::valid()
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & DiscreteStatus::valid() const
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * DiscreteStatus::clone() const
{
    return new DiscreteStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & DiscreteStatus::discreteHigh()
{
    return m_discreteHigh;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & DiscreteStatus::discreteHigh() const
{
    return m_discreteHigh;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

StepperMotorStart::StepperMotorStart()
    : MessagePayload( PayloadType::StepperMotorStart )
    , m_direction( this )
    , m_startFrequency( this )
    , m_runFrequency( this )
    , m_rampFreqPerStep( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & StepperMotorStart::direction()
{
    return m_direction;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorStart::startFrequency()
{
    return m_startFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorStart::runFrequency()
{
    return m_runFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * StepperMotorStart::clone() const
{
    return new StepperMotorStart( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & StepperMotorStart::direction() const
{
    return m_direction;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorStart::startFrequency() const
{
    return m_startFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorStart::runFrequency() const
{
    return m_runFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorStart::rampFreqPerStep()
{
    return m_rampFreqPerStep;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorStart::rampFreqPerStep() const
{
    return m_rampFreqPerStep;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

StepperMotorStartSteps::StepperMotorStartSteps()
    : MessagePayload( PayloadType::StepperMotorStartSteps )
    , m_direction( this )
    , m_steps( this )
    , m_startFrequency( this )
    , m_runFrequency( this )
    , m_rampFreqPerStep( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & StepperMotorStartSteps::direction()
{
    return m_direction;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::steps()
{
    return m_steps;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::startFrequency()
{
    return m_startFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::runFrequency()
{
    return m_runFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * StepperMotorStartSteps::clone() const
{
    return new StepperMotorStartSteps( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & StepperMotorStartSteps::direction() const
{
    return m_direction;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::steps() const
{
    return m_steps;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::startFrequency() const
{
    return m_startFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::runFrequency() const
{
    return m_runFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::rampFreqPerStep()
{
    return m_rampFreqPerStep;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorStartSteps::rampFreqPerStep() const
{
    return m_rampFreqPerStep;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

StepperMotorChangeRunFrequency::StepperMotorChangeRunFrequency()
    : MessagePayload( PayloadType::StepperMotorChangeRunFrequency )
    , m_runFrequency( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * StepperMotorChangeRunFrequency::clone() const
{
    return new StepperMotorChangeRunFrequency( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & StepperMotorChangeRunFrequency::runFrequency()
{
    return m_runFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & StepperMotorChangeRunFrequency::runFrequency() const
{
    return m_runFrequency;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

StepperMotorStatus::StepperMotorStatus()
    : MessagePayload( PayloadType::StepperMotorStatus )
    , m_valid( this )
    , m_motorRunning( this )
    , m_faultPinActive( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & StepperMotorStatus::valid()
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & StepperMotorStatus::valid() const
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & StepperMotorStatus::motorRunning()
{
    return m_motorRunning;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & StepperMotorStatus::motorRunning() const
{
    return m_motorRunning;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * StepperMotorStatus::clone() const
{
    return new StepperMotorStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & StepperMotorStatus::faultPinActive()
{
    return m_faultPinActive;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & StepperMotorStatus::faultPinActive() const
{
    return m_faultPinActive;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

AdcStatus::AdcStatus()
    : MessagePayload( PayloadType::AdcStatus )
    , m_valid( this )
    , m_adcVoltage( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & AdcStatus::valid()
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & AdcStatus::valid() const
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * AdcStatus::clone() const
{
    return new AdcStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & AdcStatus::adcVoltage()
{
    return m_adcVoltage;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & AdcStatus::adcVoltage() const
{
    return m_adcVoltage;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

WifiConfig::WifiConfig()
    : MessagePayload( PayloadType::WifiConfig )
    , m_wifiMode( this )
    , m_apSsid( this )
    , m_apPassword( this )
    , m_apIp( this )
    , m_staSsid( this )
    , m_staPassword( this )
    , m_staDhcp( this )
    , m_staStaticIp( this )
    , m_staStaticGateway( this )
    , m_staStaticNetmask( this )
    , m_staStaticDns( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<WifiMode> & WifiConfig::wifiMode()
{
    return m_wifiMode;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::apSsid()
{
    return m_apSsid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::apPassword()
{
    return m_apPassword;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::apIp()
{
    return m_apIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::staSsid()
{
    return m_staSsid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::staPassword()
{
    return m_staPassword;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & WifiConfig::staDhcp()
{
    return m_staDhcp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::staStaticIp()
{
    return m_staStaticIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::staStaticGateway()
{
    return m_staStaticGateway;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::staStaticNetmask()
{
    return m_staStaticNetmask;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * WifiConfig::clone() const
{
    return new WifiConfig( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<WifiMode> & WifiConfig::wifiMode() const
{
    return m_wifiMode;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::apSsid() const
{
    return m_apSsid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::apPassword() const
{
    return m_apPassword;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::apIp() const
{
    return m_apIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::staSsid() const
{
    return m_staSsid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::staPassword() const
{
    return m_staPassword;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & WifiConfig::staDhcp() const
{
    return m_staDhcp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::staStaticIp() const
{
    return m_staStaticIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::staStaticGateway() const
{
    return m_staStaticGateway;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::staStaticNetmask() const
{
    return m_staStaticNetmask;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiConfig::staStaticDns()
{
    return m_staStaticDns;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiConfig::staStaticDns() const
{
    return m_staStaticDns;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

WifiStatus::WifiStatus()
    : MessagePayload( PayloadType::WifiStatus )
    , m_valid( this )
    , m_apIp( this )
    , m_apMac( this )
    , m_staIp( this )
    , m_staMac( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & WifiStatus::valid()
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & WifiStatus::valid() const
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiStatus::apIp()
{
    return m_apIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiStatus::apIp() const
{
    return m_apIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiStatus::apMac()
{
    return m_apMac;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiStatus::apMac() const
{
    return m_apMac;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiStatus::staIp()
{
    return m_staIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiStatus::staIp() const
{
    return m_staIp;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * WifiStatus::clone() const
{
    return new WifiStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & WifiStatus::staMac()
{
    return m_staMac;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & WifiStatus::staMac() const
{
    return m_staMac;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

McuCommand::McuCommand()
    : MessagePayload( PayloadType::McuCommand )
    , m_command( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * McuCommand::clone() const
{
    return new McuCommand( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & McuCommand::command()
{
    return m_command;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & McuCommand::command() const
{
    return m_command;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

McuReply::McuReply()
    : MessagePayload( PayloadType::McuReply )
    , m_reply( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * McuReply::clone() const
{
    return new McuReply( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & McuReply::reply()
{
    return m_reply;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & McuReply::reply() const
{
    return m_reply;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

JsonMessage::JsonMessage()
    : MessagePayload( PayloadType::JsonMessage )
    , m_json( this )
    , m_refMsgCounter( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * JsonMessage::clone() const
{
    return new JsonMessage( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & JsonMessage::json()
{
    return m_json;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & JsonMessage::json() const
{
    return m_json;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & JsonMessage::refMsgCounter()
{
    return m_refMsgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & JsonMessage::refMsgCounter() const
{
    return m_refMsgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayloadRef::MessagePayloadRef( ProtoApi::Message * const pMessage )
    : ProtoApi::DataBase( pMessage )
    , m_payloadType( PayloadType::None )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayloadRef::~MessagePayloadRef()
{
    delete m_pValue;
    m_pValue = nullptr;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void MessagePayloadRef::serializeData() const
{
    message()->serializeData( &m_payloadType, sizeof( m_payloadType ) );

    if ( m_pValue )
    {
        m_pValue->serialize();
        message()->serializeData( m_pValue->serializedData().data(), m_pValue->serializedData().size() );
    }
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

bool MessagePayloadRef::deserializeData( ProtoApi::Message & message )
{
    bool bSuccess = message.deserializeData( &m_payloadType, sizeof( m_payloadType ) );

    delete m_pValue;
    m_pValue = nullptr;

    switch ( m_payloadType )
    {
        case PayloadType::None:
            // hmmh ... error case
            bSuccess = false;
            break;
        case PayloadType::Ack:
            m_pValue = new Ack();
            break;
        case PayloadType::Nack:
            m_pValue = new Nack();
            break;
        case PayloadType::Ping:
            m_pValue = new Ping();
            break;
        case PayloadType::Pong:
            m_pValue = new Pong();
            break;
        case PayloadType::Reset:
            m_pValue = new Reset();
            break;
        case PayloadType::DiscreteStatus:
            m_pValue = new DiscreteStatus();
            break;
        case PayloadType::AdcStatus:
            m_pValue = new AdcStatus();
            break;
        case PayloadType::DcHallStartMotor:
            m_pValue = new DcHallStartMotor();
            break;
        case PayloadType::DcHallStartMotorSteps:
            m_pValue = new DcHallStartMotorSteps();
            break;
        case PayloadType::DcHallStopMotor:
            m_pValue = new DcHallStopMotor();
            break;
        case PayloadType::DcHallTestMotor:
            m_pValue = new DcHallTestMotor();
            break;
        case PayloadType::DcHallStatus:
            m_pValue = new DcHallStatus();
            break;
        case PayloadType::EepromFlash:
            m_pValue = new EepromFlash();
            break;
        case PayloadType::EepromStatus:
            m_pValue = new EepromStatus();
            break;
        case PayloadType::PwmFaderSettings:
            m_pValue = new PwmFaderSettings();
            break;
        case PayloadType::PwmFadeIn:
            m_pValue = new PwmFadeIn();
            break;
        case PayloadType::PwmFadeOut:
            m_pValue = new PwmFadeOut();
            break;
        case PayloadType::PwmSetDuty:
            m_pValue = new PwmSetDuty();
            break;
        case PayloadType::StepperMotorChangeRunFrequency:
            m_pValue = new StepperMotorChangeRunFrequency();
            break;
        case PayloadType::StepperMotorStart:
            m_pValue = new StepperMotorStart();
            break;
        case PayloadType::StepperMotorStartSteps:
            m_pValue = new StepperMotorStartSteps();
            break;
        case PayloadType::StepperMotorStatus:
            m_pValue = new StepperMotorStatus();
            break;
        case PayloadType::StepperMotorStop:
            m_pValue = new StepperMotorStop();
            break;
        case PayloadType::RequestDriverStatus:
            m_pValue = new RequestDriverStatus();
            break;
        case PayloadType::WifiConfig:
            m_pValue = new WifiConfig();
            break;
        case PayloadType::WifiStatus:
            m_pValue = new WifiStatus();
            break;
        case PayloadType::McuCommand:
            m_pValue = new McuCommand();
            break;
        case PayloadType::McuReply:
            m_pValue = new McuReply();
            break;
        case PayloadType::JsonMessage:
            m_pValue = new JsonMessage();
            break;
        case PayloadType::FileDownloadStartRequest:
            m_pValue = new FileDownloadStartRequest();
            break;
        case PayloadType::FileDownloadStartResponse:
            m_pValue = new FileDownloadStartResponse();
            break;
        case PayloadType::FileDownloadDataRequest:
            m_pValue = new FileDownloadDataRequest();
            break;
        case PayloadType::FileDownloadDataResponse:
            m_pValue = new FileDownloadDataResponse();
            break;
        case PayloadType::FileUploadStart:
            m_pValue = new FileUploadStart();
            break;
        case PayloadType::FileUploadData:
            m_pValue = new FileUploadData();
            break;
        case PayloadType::FileUploadStop:
            m_pValue = new FileUploadStop();
            break;
        case PayloadType::SwUpdateCommand:
            m_pValue = new SwUpdateCommand();
            break;
        case PayloadType::SwUpdateStatus:
            m_pValue = new SwUpdateStatus();
            break;
        case PayloadType::SystemStatus:
            m_pValue = new SystemStatus();
            break;

        case PayloadType::Last:
        default:
            static_assert( static_cast<int>( PayloadType::Last ) == 40 );
            bSuccess = false;
            break;
    }

    if ( m_pValue )
    {
        bSuccess = bSuccess
                   && m_pValue->deserialize( message );
    }

    return bSuccess;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t MessagePayloadRef::size() const
{
    uint32_t u32Size = sizeof( m_payloadType );

    if ( m_pValue )
    {
        u32Size += m_pValue->size();
    }

    return u32Size;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

PayloadType MessagePayloadRef::payloadType() const
{
    return m_payloadType;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const MessagePayload * MessagePayloadRef::value() const
{
    return m_pValue;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void MessagePayloadRef::setValue( MessagePayload * pValue )
{
    delete m_pValue;

    m_pValue = pValue;

    if ( m_pValue )
    {
        m_payloadType = m_pValue->payloadType();
    }
    else
    {
        m_payloadType = PayloadType::None;
    }
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Nack::Nack()
    : MessagePayload( PayloadType::Nack )
    , m_nackReason( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<Nack::NackReason> & Nack::nackReason()
{
    return m_nackReason;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<Nack::NackReason> & Nack::nackReason() const
{
    return m_nackReason;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * Nack::clone() const
{
    return new Nack( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

FileUploadStart::FileUploadStart()
    : MessagePayload( PayloadType::FileUploadStart )
    , m_fileName( this )
    , m_fileSize( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & FileUploadStart::fileName()
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & FileUploadStart::fileName() const
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * FileUploadStart::clone() const
{
    return new FileUploadStart( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileUploadStart::fileSize()
{
    return m_fileSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileUploadStart::fileSize() const
{
    return m_fileSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

FileUploadStop::FileUploadStop()
    : MessagePayload( PayloadType::FileUploadStop )
    , m_stopReason( this )
    , m_transferedSize( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<FileUploadStop::StopReason> & FileUploadStop::stopReason()
{
    return m_stopReason;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<FileUploadStop::StopReason> & FileUploadStop::stopReason() const
{
    return m_stopReason;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * FileUploadStop::clone() const
{
    return new FileUploadStop( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileUploadStop::transferedSize()
{
    return m_transferedSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileUploadStop::transferedSize() const
{
    return m_transferedSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

FileUploadData::FileUploadData()
    : MessagePayload( PayloadType::FileUploadData )
    , m_chunkNo( this )
    , m_chunkOffset( this )
    , m_chunkData( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * FileUploadData::clone() const
{
    return new FileUploadData( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileUploadData::chunkNo()
{
    return m_chunkNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileUploadData::chunkNo() const
{
    return m_chunkNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileUploadData::chunkOffset()
{
    return m_chunkOffset;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileUploadData::chunkOffset() const
{
    return m_chunkOffset;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & FileUploadData::chunkData()
{
    return m_chunkData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & FileUploadData::chunkData() const
{
    return m_chunkData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * RequestDriverStatus::clone() const
{
    return new RequestDriverStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

SwUpdateCommand::SwUpdateCommand()
    : MessagePayload( PayloadType::SwUpdateCommand )
    , m_cmd( this )
    , m_transactionId( this )
    , m_chunkNo( this )
    , m_chunkData( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * SwUpdateCommand::clone() const
{
    return new SwUpdateCommand( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<SwUpdateCmd> & SwUpdateCommand::cmd()
{
    return m_cmd;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & SwUpdateCommand::transactionId()
{
    return m_transactionId;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & SwUpdateCommand::chunkNo()
{
    return m_chunkNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<SwUpdateCmd> & SwUpdateCommand::cmd() const
{
    return m_cmd;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & SwUpdateCommand::transactionId() const
{
    return m_transactionId;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & SwUpdateCommand::chunkNo() const
{
    return m_chunkNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & SwUpdateCommand::chunkData()
{
    return m_chunkData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & SwUpdateCommand::chunkData() const
{
    return m_chunkData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

SwUpdateStatus::SwUpdateStatus()
    : MessagePayload( PayloadType::SwUpdateStatus )
    , m_valid( this )
    , m_cmd( this )
    , m_success( this )
    , m_transactionId( this )
    , m_swVersionNo( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * SwUpdateStatus::clone() const
{
    return new SwUpdateStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & SwUpdateStatus::valid()
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & SwUpdateStatus::valid() const
{
    return m_valid;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<SwUpdateCmd> & SwUpdateStatus::cmd()
{
    return m_cmd;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<SwUpdateCmd> & SwUpdateStatus::cmd() const
{
    return m_cmd;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<bool> & SwUpdateStatus::success()
{
    return m_success;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<bool> & SwUpdateStatus::success() const
{
    return m_success;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & SwUpdateStatus::transactionId()
{
    return m_transactionId;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & SwUpdateStatus::transactionId() const
{
    return m_transactionId;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & SwUpdateStatus::swVersionNo()
{
    return m_swVersionNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & SwUpdateStatus::swVersionNo() const
{
    return m_swVersionNo;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const char * payloadTypeString( const Payload::PayloadType payloadType )
{
    const char * payloadString = "Unknown";

    switch ( payloadType )
    {
        case PayloadType::None:
            payloadString = "None";
            break;
        case PayloadType::Ack:
            payloadString = "Ack";
            break;
        case PayloadType::Nack:
            payloadString = "Nack";
            break;
        case PayloadType::Ping:
            payloadString = "Ping";
            break;
        case PayloadType::Pong:
            payloadString = "Pong";
            break;
        case PayloadType::Reset:
            payloadString = "Reset";
            break;
        case PayloadType::DiscreteStatus:
            payloadString = "DiscreteStatus";
            break;
        case PayloadType::AdcStatus:
            payloadString = "AdcStatus";
            break;
        case PayloadType::DcHallStartMotor:
            payloadString = "DcHallStartMotor";
            break;
        case PayloadType::DcHallStartMotorSteps:
            payloadString = "DcHallStartMotorSteps";
            break;
        case PayloadType::DcHallStopMotor:
            payloadString = "DcHallStopMotor";
            break;
        case PayloadType::DcHallTestMotor:
            payloadString = "DcHallTestMotor";
            break;
        case PayloadType::DcHallStatus:
            payloadString = "DcHallStatus";
            break;
        case PayloadType::EepromFlash:
            payloadString = "EepromFlash";
            break;
        case PayloadType::EepromStatus:
            payloadString = "EepromStatus";
            break;
        case PayloadType::PwmFaderSettings:
            payloadString = "PwmFaderSettings";
            break;
        case PayloadType::PwmFadeIn:
            payloadString = "PwmFadeIn";
            break;
        case PayloadType::PwmFadeOut:
            payloadString = "PwmFadeOut";
            break;
        case PayloadType::PwmSetDuty:
            payloadString = "PwmSetDuty";
            break;
        case PayloadType::StepperMotorChangeRunFrequency:
            payloadString = "StepperMotorChangeRunFrequency";
            break;
        case PayloadType::StepperMotorStart:
            payloadString = "StepperMotorStart";
            break;
        case PayloadType::StepperMotorStartSteps:
            payloadString = "StepperMotorStartSteps";
            break;
        case PayloadType::StepperMotorStatus:
            payloadString = "StepperMotorStatus";
            break;
        case PayloadType::StepperMotorStop:
            payloadString = "StepperMotorStop";
            break;
        case PayloadType::RequestDriverStatus:
            payloadString = "RequestDriverStatus";
            break;
        case PayloadType::WifiConfig:
            payloadString = "WifiConfig";
            break;
        case PayloadType::WifiStatus:
            payloadString = "WifiStatus";
            break;
        case PayloadType::McuCommand:
            payloadString = "McuCommand";
            break;
        case PayloadType::McuReply:
            payloadString = "McuReply";
            break;
        case PayloadType::JsonMessage:
            payloadString = "JsonMessage";
            break;
        case PayloadType::FileDownloadStartRequest:
            payloadString = "FileDownloadStartRequest";
            break;
        case PayloadType::FileDownloadStartResponse:
            payloadString = "FileDownloadStartResponse";
            break;
        case PayloadType::FileDownloadDataRequest:
            payloadString = "FileDownloadDataRequest";
            break;
        case PayloadType::FileDownloadDataResponse:
            payloadString = "FileDownloadDataResponse";
            break;
        case PayloadType::FileUploadStart:
            payloadString = "FileUploadStart";
            break;
        case PayloadType::FileUploadData:
            payloadString = "FileUploadData";
            break;
        case PayloadType::FileUploadStop:
            payloadString = "FileUploadStop";
            break;
        case PayloadType::SwUpdateCommand:
            payloadString = "SwUpdateCommand";
            break;
        case PayloadType::SwUpdateStatus:
            payloadString = "SwUpdateStatus";
            break;
        case PayloadType::SystemStatus:
            payloadString = "SystemStatus";
            break;

        case PayloadType::Last:
        default:
            static_assert( static_cast<int>( PayloadType::Last ) == 40 );
            break;
    }

    return payloadString;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

FileDownloadStartRequest::FileDownloadStartRequest()
    : MessagePayload( PayloadType::FileDownloadStartRequest )
    , m_fileName( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * FileDownloadStartRequest::clone() const
{
    return new FileDownloadStartRequest( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & FileDownloadStartRequest::fileName()
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & FileDownloadStartRequest::fileName() const
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

FileDownloadStartResponse::FileDownloadStartResponse()
    : MessagePayload( PayloadType::FileDownloadStartResponse )
    , m_fileName( this )
    , m_fileSize( this )
    , m_status( this )
    , m_refMsgCounter( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * FileDownloadStartResponse::clone() const
{
    return new FileDownloadStartResponse( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & FileDownloadStartResponse::fileName()
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & FileDownloadStartResponse::fileName() const
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileDownloadStartResponse::fileSize()
{
    return m_fileSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileDownloadStartResponse::fileSize() const
{
    return m_fileSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<FileDownloadStatus> & FileDownloadStartResponse::status()
{
    return m_status;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<FileDownloadStatus> & FileDownloadStartResponse::status() const
{
    return m_status;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileDownloadStartResponse::refMsgCounter()
{
    return m_refMsgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileDownloadStartResponse::refMsgCounter() const
{
    return m_refMsgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

FileDownloadDataRequest::FileDownloadDataRequest()
    : MessagePayload( PayloadType::FileDownloadDataRequest )
    , m_fileName( this )
    , m_chunkOffset( this )
    , m_chunkSize( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * FileDownloadDataRequest::clone() const
{
    return new FileDownloadDataRequest( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & FileDownloadDataRequest::fileName()
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & FileDownloadDataRequest::fileName() const
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileDownloadDataRequest::chunkOffset()
{
    return m_chunkOffset;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileDownloadDataRequest::chunkOffset() const
{
    return m_chunkOffset;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileDownloadDataRequest::chunkSize()
{
    return m_chunkSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileDownloadDataRequest::chunkSize() const
{
    return m_chunkSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

FileDownloadDataResponse::FileDownloadDataResponse()
    : MessagePayload( PayloadType::FileDownloadDataResponse )
    , m_fileName( this )
    , m_chunkOffset( this )
    , m_chunkData( this )
    , m_status( this )
    , m_refMsgCounter( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessagePayload * FileDownloadDataResponse::clone() const
{
    return new FileDownloadDataResponse( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & FileDownloadDataResponse::fileName()
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & FileDownloadDataResponse::fileName() const
{
    return m_fileName;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileDownloadDataResponse::chunkOffset()
{
    return m_chunkOffset;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileDownloadDataResponse::chunkOffset() const
{
    return m_chunkOffset;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataString & FileDownloadDataResponse::chunkData()
{
    return m_chunkData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataString & FileDownloadDataResponse::chunkData() const
{
    return m_chunkData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<FileDownloadStatus> & FileDownloadDataResponse::status()
{
    return m_status;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<FileDownloadStatus> & FileDownloadDataResponse::status() const
{
    return m_status;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & FileDownloadDataResponse::refMsgCounter()
{
    return m_refMsgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & FileDownloadDataResponse::refMsgCounter() const
{
    return m_refMsgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

SystemStatus::SystemStatus()
: MessagePayload( PayloadType::SystemStatus )
, m_status( this )
, m_freeHeapSize( this )
, m_messageNumTx( this )
, m_messageNumRx( this )
, m_messageNumRxErrors( this )
, m_messageNumTxTimeouts( this )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

SystemStatus* SystemStatus::clone() const
{
    return new SystemStatus( *this );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<SystemStatus::Status>& SystemStatus::status()
{
    return m_status;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<SystemStatus::Status>& SystemStatus::status() const
{
    return m_status;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t>& SystemStatus::freeHeapSize()
{
    return m_freeHeapSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t>& SystemStatus::freeHeapSize() const
{
    return m_freeHeapSize;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumTx()
{
    return m_messageNumTx;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumTx() const
{
    return m_messageNumTx;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumRx()
{
    return m_messageNumRx;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumRx() const
{
    return m_messageNumRx;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumRxErrors()
{
    return m_messageNumRxErrors;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumRxErrors() const
{
    return m_messageNumRxErrors;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumTxTimeouts()
{
    return m_messageNumTxTimeouts;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t>& SystemStatus::messageNumTxTimeouts() const
{
    return m_messageNumTxTimeouts;
}

} // namespace Payload

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessageFrame::MessageFrame()
    : m_preamble( this )
    , m_length( this )
    , m_driverId( this )
    , m_msgCounter( this )
    , m_repeatCounter( this )
    , m_payloadRef( this )
    , m_crc32( this )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & MessageFrame::preamble()
{
    return m_preamble;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & MessageFrame::preamble() const
{
    return m_preamble;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & MessageFrame::length()
{
    return m_length;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & MessageFrame::length() const
{
    return m_length;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<DriverId> & MessageFrame::driverId()
{
    return m_driverId;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<DriverId> & MessageFrame::driverId() const
{
    return m_driverId;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & MessageFrame::msgCounter()
{
    return m_msgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & MessageFrame::msgCounter() const
{
    return m_msgCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint8_t> & MessageFrame::repeatCounter()
{
    return m_repeatCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint8_t> & MessageFrame::repeatCounter() const
{
    return m_repeatCounter;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Payload::MessagePayloadRef & MessageFrame::payloadRef()
{
    return m_payloadRef;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const Payload::MessagePayloadRef & MessageFrame::payloadRef() const
{
    return m_payloadRef;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ProtoApi::DataFixed<uint32_t> & MessageFrame::crc32()
{
    return m_crc32;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const ProtoApi::DataFixed<uint32_t> & MessageFrame::crc32() const
{
    return m_crc32;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Serializer::Serializer( std::function<void ( const std::string &, MessageFrame & )> calcCheckSum )
    : m_calcCheckSum( calcCheckSum )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void Serializer::serialize( MessageFrame & message )
{
    message.preamble().setValue( MessageFrame::c_u32Preamble );

    // start first serialize to get size
    message.serialize();
    message.length().setValue( message.serializedData().size() );

    // now update the serialize result including correct length bytes
    message.serialize();
    m_strSerializedData = message.serializedData();
    m_strSerializedData.resize( m_strSerializedData.size() - message.crc32().size() );

    m_calcCheckSum( m_strSerializedData, message );

    // final serialize including correct CRC bytes
    message.serialize();
    m_strSerializedData = message.serializedData();
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const std::string & Serializer::serializedData() const
{
    return m_strSerializedData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Deserializer::Deserializer( std::function<void (const std::string &, MessageFrame &)> calcCheckSum )
    : m_calcCheckSum( calcCheckSum )
{

}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void Deserializer::addStreamData( const uint8_t * const pData,
                                  const uint32_t        u32Size )
{
    uint32_t u32StreamSize = m_strStreamData.size();

    m_strStreamData.resize( u32StreamSize + u32Size );
    std::memcpy( const_cast<char *>( m_strStreamData.data() ) + u32StreamSize, pData, u32Size );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

void Deserializer::flushStreamData()
{
    m_strStreamData.clear();
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

Deserializer::ParseResult Deserializer::parseData()
{
    ParseResult result = ParseResult::NoPreamble;

    uint32_t u32StreamSize   = m_strStreamData.size();
    uint32_t u32PreambleSize = m_messageFrame.preamble().size();
    uint32_t u32LengthSize   = m_messageFrame.length().size();
    uint32_t u32Crc32Size    = m_messageFrame.crc32().size();

    int i = 0;
    for ( i = 0;
          i < ( static_cast<int>( u32StreamSize ) - static_cast<int>( u32PreambleSize ) );
          i++ )
    {
        const uint32_t * pu32Preamble = reinterpret_cast<const uint32_t *>( m_strStreamData.data() + i );

        if ( *pu32Preamble == MessageFrame::c_u32Preamble )
        {
            uint32_t u32PreamblePos = static_cast<uint32_t>( i );
            uint32_t u32LengthPos   = u32PreamblePos + u32PreambleSize;

            if ( u32LengthPos + u32LengthSize > u32StreamSize )
            {
                result = ParseResult::Incomplete;
            }
            else
            {
                const uint32_t * pu32Length = reinterpret_cast<const uint32_t *>( m_strStreamData.data() + u32LengthPos );

                if ( u32PreamblePos + *pu32Length > u32StreamSize )
                {
                    result = ParseResult::Incomplete;
                }
                else if ( *pu32Length < u32PreambleSize + u32LengthSize + u32Crc32Size )
                {
                    result = ParseResult::Invalid;
                }
                else
                {
                    uint32_t         u32Crc32Pos = u32PreamblePos + *pu32Length - u32Crc32Size;
                    const uint32_t * pu32Crc32   = reinterpret_cast<const uint32_t *>( m_strStreamData.data() + u32Crc32Pos );

                    std::string strFrameData = m_strStreamData.substr( u32PreamblePos, *pu32Length );
                    m_calcCheckSum( strFrameData.substr( 0, strFrameData.size() - u32Crc32Size ), m_messageFrame );

                    if ( m_messageFrame.crc32().value() == *pu32Crc32 )
                    {
                        if ( m_messageFrame.deserialize( strFrameData ) )
                        {
                            result = ParseResult::Success;

                            m_messageFrame.deserialize( strFrameData );
                            i = u32PreamblePos + *pu32Length;
                        }
                        else
                        {
                            result = ParseResult::Invalid;
                            printf( "Deserializer::parseData() deserialize invalid\n" );
                        }
                    }
                    else
                    {
                        result = ParseResult::WrongCrc;

                        if ( m_messageFrame.deserialize( strFrameData ) )
                        {
                            m_messageFrame.deserialize( strFrameData );
                            i = u32PreamblePos + 1;
                            printf( "Deserializer::parseData() wrong CRC\n" );
                        }
                        else
                        {
                            result = ParseResult::Invalid;
                            printf( "Deserializer::parseData() wrong CRC and invalid\n" );
                        }
                    }
                }
            }

            if ( result == ParseResult::Invalid )
            {
                // continue with next byte try to find new preamble
            }
            else
            {
                break;
            }
        }
    }

    // eat up parsed bytes
    m_strStreamData = m_strStreamData.substr( i );

    return result;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

bool Deserializer::hasData() const
{
    return !m_strStreamData.empty();
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const MessageFrame & Deserializer::messageFrame() const
{
    return m_messageFrame;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

MessageFrame & Deserializer::messageFrame()
{
    return m_messageFrame;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

const std::string & Deserializer::streamData() const
{
    return m_strStreamData;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

} // namespace EkxProtocol
