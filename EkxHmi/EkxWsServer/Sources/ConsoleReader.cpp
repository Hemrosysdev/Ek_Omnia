///////////////////////////////////////////////////////////////////////////////
///
/// @file ConsoleReader.cpp
///
/// @brief main application entry point of ConsoleReader.
///
/// @author Ultratronik GmbH \n
///         Dornierstr. 9 \n
///         D-82205 Gilching \n
///         Germany
///         http://www.ultratronik.de
///
/// @author written by Gerd Esser, Forschung & Entwicklung, gesser@ultratronik.de
///
/// @date 01.04.2020
///
/// @copyright Copyright 2020 by Hemro International AG \n
///            Hemro International AG \n
///            Länggenstrasse 34 \n
///            CH 8184 Bachenbülach \n
///            Switzerland \n
///            Homepage: www.hemrogroup.com
///
///////////////////////////////////////////////////////////////////////////////

#include "ConsoleReader.h"

#include <stdio.h>
#include <unistd.h>

///////////////////////////////////////////////////////////////////////////////
//
//
///////////////////////////////////////////////////////////////////////////////

ConsoleReader::ConsoleReader()
{
    initTermios( 0 );
}

///////////////////////////////////////////////////////////////////////////////
//
//
///////////////////////////////////////////////////////////////////////////////

ConsoleReader::~ConsoleReader()
{
    resetTermios();

    terminate();
    wait();
}

///////////////////////////////////////////////////////////////////////////////
//
//
///////////////////////////////////////////////////////////////////////////////

void ConsoleReader::run()
{
    forever
    {
        emit keyPressed( getch() );
    }
}

///////////////////////////////////////////////////////////////////////////////
//
//
///////////////////////////////////////////////////////////////////////////////

/* Initialize new terminal i/o settings */
void ConsoleReader::initTermios( const int echo )
{
    /* grab old terminal i/o settings */
    tcgetattr( 0, &m_oldSettings );

    /* make new settings same as old settings */
    m_newSettings = m_oldSettings;
    /* disable buffered i/o */
    m_newSettings.c_lflag &= ~static_cast<unsigned int>( ICANON );
    /* set echo mode */
    m_newSettings.c_lflag &= echo ? static_cast<unsigned int>( ECHO ) : ~static_cast<unsigned int>( ECHO );

    /* use these new terminal i/o settings now */
    tcsetattr( 0, TCSANOW, &m_newSettings );
}

///////////////////////////////////////////////////////////////////////////////
//
//
///////////////////////////////////////////////////////////////////////////////

/* Restore old terminal i/o settings */
void ConsoleReader::resetTermios( void )
{
    tcsetattr( 0, TCSANOW, &m_oldSettings );
}

///////////////////////////////////////////////////////////////////////////////
//
//
///////////////////////////////////////////////////////////////////////////////

/* Read 1 character without echo */
int ConsoleReader::getch( void )
{
    return getchar();
}

///////////////////////////////////////////////////////////////////////////////
//
//
///////////////////////////////////////////////////////////////////////////////

